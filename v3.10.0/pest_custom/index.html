<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Wrapping Optimization Packages · PEtab.jl</title><meta name="title" content="Wrapping Optimization Packages · PEtab.jl"/><meta property="og:title" content="Wrapping Optimization Packages · PEtab.jl"/><meta property="twitter:title" content="Wrapping Optimization Packages · PEtab.jl"/><meta name="description" content="Documentation for PEtab.jl."/><meta property="og:description" content="Documentation for PEtab.jl."/><meta property="twitter:description" content="Documentation for PEtab.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="../assets/custom_theme.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">PEtab.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../tutorial/">Tutorial</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Extended Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../petab_simcond/">Simulation conditions</a></li><li><a class="tocitem" href="../petab_preeq_simulations/">Steady-State Simulations (Pre-Equilibration)</a></li><li><a class="tocitem" href="../petab_event/">Events (callbacks, dosages, etc.)</a></li><li><a class="tocitem" href="../petab_cond_specific/">Simulation Condition-Specific Parameters</a></li><li><a class="tocitem" href="../petab_obs_noise/">Noise and Observable Parameters</a></li><li><a class="tocitem" href="../import_petab/">Importing PEtab Standard Format</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox" checked/><label class="tocitem" for="menuitem-4"><span class="docs-label">Parameter Estimation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../pest_method/">Parameter Estimation Methods</a></li><li><a class="tocitem" href="../pest_plot/">Plotting Estimation Results</a></li><li><a class="tocitem" href="../pest_algs/">Available and Recommended Algorithms</a></li><li><a class="tocitem" href="../pest_select/">Model Selection with PEtab-select</a></li><li class="is-active"><a class="tocitem" href>Wrapping Optimization Packages</a><ul class="internal"><li><a class="tocitem" href="#Extracting-Relevant-Input-from-a-PEtabODEProblem"><span>Extracting Relevant Input from a PEtabODEProblem</span></a></li><li><a class="tocitem" href="#Wrapping-Optim.jl-IPNewton"><span>Wrapping Optim.jl IPNewton</span></a></li><li><a class="tocitem" href="#References"><span>References</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../inference/">Bayesian Inference</a></li><li><a class="tocitem" href="../API/">API</a></li><li><a class="tocitem" href="../grad_hess_methods/">Gradient and Hessian Methods</a></li><li><a class="tocitem" href="../default_options/">Default Options</a></li><li><input class="collapse-toggle" id="menuitem-9" type="checkbox"/><label class="tocitem" for="menuitem-9"><span class="docs-label">Performance Tips</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../nonstiff_models/">Non-Biology (Non-Stiff) Models</a></li><li><a class="tocitem" href="../Beer/">Condition-Specific Parameters</a></li><li><a class="tocitem" href="../Bachmann/">Adjoint Sensitivity Analysis (Large Models)</a></li></ul></li><li><a class="tocitem" href="../references/">References</a></li><li><a class="tocitem" href="../FAQ/">FAQ</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Parameter Estimation</a></li><li class="is-active"><a href>Wrapping Optimization Packages</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Wrapping Optimization Packages</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/sebapersson/PEtab.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/sebapersson/PEtab.jl/blob/main/docs/src/pest_custom.md#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="wrap_est"><a class="docs-heading-anchor" href="#wrap_est">Wrapping Optimization Packages</a><a id="wrap_est-1"></a><a class="docs-heading-anchor-permalink" href="#wrap_est" title="Permalink"></a></h1><p>A <code>PEtabODEProblem</code> contains all the necessary information for wrapping a suitable optimizer to estimate model parameters. Since wrapping a package can be cumbersome, PEtab.jl provides wrappers for performing single-start parameter estimation (with <a href="../API/#PEtab.calibrate"><code>calibrate</code></a>) and multi-start parameter estimation (with <a href="../API/#PEtab.calibrate_multistart"><code>calibrate_multistart</code></a>). More details can be found in <a href="../pest_method/#pest_methods">this</a> tutorial. Still, in some cases, it may be necessary to manually wrap one of the optimization packages not supported by PEtab.jl.</p><p>This tutorial show how to wrap an existing optimization package, using the <code>IPNewton</code> method from <a href="https://github.com/JuliaNLSolvers/Optim.jl">Optim.jl</a> as an example. As a working example, we use the Michaelis-Menten enzyme kinetics model from the starting <a href="../tutorial/#tutorial">tutorial</a>. Even though the code below provides the model as a <code>ReactionSystem</code>, everything works exactly the same if the model is provided as an <code>ODESystem</code>.</p><pre><code class="language-julia hljs">using Catalyst, PEtab

# Create the dynamic model
rn = @reaction_network begin
    @parameters S0 c3=1.0
    @species S(t)=S0
    c1, S + E --&gt; SE
    c2, SE --&gt; S + E
    c3, SE --&gt; P + E
end
speciemap = [:E =&gt; 50.0, :SE =&gt; 0.0, :P =&gt; 0.0]

# Observables
@unpack E, S = rn
obs_sum = PEtabObservable(S + E, 3.0)
@unpack P = rn
@parameters sigma
obs_p = PEtabObservable(P, sigma)
observables = Dict(&quot;obs_p&quot; =&gt; obs_p, &quot;obs_sum&quot; =&gt; obs_sum)

# Parameters to estimate
p_c1 = PEtabParameter(:c1)
p_c2 = PEtabParameter(:c2)
p_s0 = PEtabParameter(:S0)
p_sigma = PEtabParameter(:sigma)
pest = [p_c1, p_c2, p_s0, p_sigma]

# Simulate measurement data with &#39;true&#39; parameters
using OrdinaryDiffEq, DataFrames
ps = [:c1 =&gt; 1.0, :c2 =&gt; 10.0, :c3 =&gt; 1.0, :S0 =&gt; 100.0]
u0 = [:S =&gt; 100.0, :E =&gt; 50.0, :SE =&gt; 0.0, :P =&gt; 0.0]
tspan = (0.0, 10.0)
oprob = ODEProblem(rn, u0, tspan, ps)
sol = solve(oprob, Rodas5P(); saveat = 0:0.5:10.0)
obs_sum = (sol[:S] + sol[:E]) .+ randn(length(sol[:E]))
obs_p = sol[:P] + .+ randn(length(sol[:P]))
df_sum = DataFrame(obs_id = &quot;obs_sum&quot;, time = sol.t, measurement = obs_sum)
df_p = DataFrame(obs_id = &quot;obs_p&quot;, time = sol.t, measurement = obs_p)
measurements = vcat(df_sum, df_p)

model = PEtabModel(rn, observables, measurements, pest; speciemap = speciemap)
petab_prob = PEtabODEProblem(model)</code></pre><h2 id="Extracting-Relevant-Input-from-a-PEtabODEProblem"><a class="docs-heading-anchor" href="#Extracting-Relevant-Input-from-a-PEtabODEProblem">Extracting Relevant Input from a PEtabODEProblem</a><a id="Extracting-Relevant-Input-from-a-PEtabODEProblem-1"></a><a class="docs-heading-anchor-permalink" href="#Extracting-Relevant-Input-from-a-PEtabODEProblem" title="Permalink"></a></h2><p>A numerical optimizer requires an objective function, and derivative-based methods also need a gradient function and, in some cases, a Hessian function. Following the <a href="https://petab.readthedocs.io/en/latest/">PEtab standard</a>, PEtab.jl works with likelihoods, so the objective function corresponds to the negative log-likelihood (<code>nllh</code>), which can be accessed with:</p><pre><code class="language-julia hljs">x = get_x(petab_prob)
nllh = petab_prob.nllh(x; prior = true)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">54807.5096437388</code></pre><p>Here, the keyword argument <code>prior = true</code> (default) ensures that potential parameter priors are considered when computing the likelihood. Furthermore, the <code>PEtabODEProblem</code> provides both in-place and out-of-place gradient functions:</p><pre><code class="language-julia hljs">g_inplace = similar(x)
petab_prob.grad!(g_inplace, x; prior = true)
g_outplace = petab_prob.grad(x)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">ComponentVector{Float64}(log10_c1 = -547.174693385283, log10_c2 = 545.8408580927436, log10_S0 = 445488.9612553938, log10_sigma = 39.9402452208846)</code></pre><p>as well as in-place and out-of-place Hessian functions:</p><pre><code class="language-julia hljs">h_inplace = zeros(length(x), length(x))
petab_prob.hess!(h_inplace, x; prior = true)
h_outplace = petab_prob.hess(x)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">4×4 Matrix{Float64}:
  1358.73      -1355.53      -3460.2        -0.292323
 -1355.53       1355.41       3453.85        0.291772
 -3460.2        3453.85          3.41892e6  -8.61346
    -0.292323      0.291772     -8.61346    38.7481</code></pre><p>In the above cases, the input parameter vector is a <code>ComponentArray</code>, but a <code>Vector</code> input is also accepted, and in this case, the gradient functions will also output a <code>Vector</code>. Additionally, the gradients and Hessians are computed using the default methods in the <code>PEtabODEProblem</code> (for more details, see <a href="../default_options/#default_options">this</a> page).</p><p>Lastly, for parameter estimation with ODE models, it is often useful to set parameter bounds. Because, without bounds, the optimization algorithm can explore regions where the ODE solver fails to solve the model which prolongs runtime [<a href="../references/#frohlich2022fides">1</a>]. The bounds can be accessed via:</p><pre><code class="language-julia hljs">lb, ub = petab_prob.lower_bounds, petab_prob.upper_bounds</code></pre><p>Both <code>lb</code> and <code>ub</code> are <code>ComponentArray</code>s. If an optimization package does not support <code>ComponentArray</code> (as in the example below), they can be converted to a <code>Vector</code> by calling <code>collect</code>.</p><h2 id="Wrapping-Optim.jl-IPNewton"><a class="docs-heading-anchor" href="#Wrapping-Optim.jl-IPNewton">Wrapping Optim.jl IPNewton</a><a id="Wrapping-Optim.jl-IPNewton-1"></a><a class="docs-heading-anchor-permalink" href="#Wrapping-Optim.jl-IPNewton" title="Permalink"></a></h2><p>From the Optim.jl <a href="https://julianlsolvers.github.io/Optim.jl/stable/">documentation</a>, we can see that in order to use the <code>IPNewton</code> method, we need to provide the objective, gradient, Hessian, and parameter bounds, where the latter are provided as vectors. Using the information outlined above, we can do:</p><pre><code class="language-julia hljs">using Optim
x0 = collect(get_x(petab_prob))
df = TwiceDifferentiable(petab_prob.nllh, petab_prob.grad!, petab_prob.hess!, x0)
dfc = TwiceDifferentiableConstraints(collect(lb), collect(ub))</code></pre><p>Note that we convert any <code>ComponentArray</code> to a <code>Vector</code> with <code>collect</code>. Given this, we can perform parameter estimation with <code>x0</code> as the starting point:</p><pre><code class="language-julia hljs">res = Optim.optimize(df, dfc, x0, IPNewton())</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi"> * Status: success (objective increased between iterations)

 * Candidate solution
    Final objective value:     7.914729e+01

 * Found with
    Algorithm:     Interior Point Newton

 * Convergence measures
    |x - x&#39;|               = 0.00e+00 ≤ 0.0e+00
    |x - x&#39;|/|x&#39;|          = 0.00e+00 ≤ 0.0e+00
    |f(x) - f(x&#39;)|         = 0.00e+00 ≤ 0.0e+00
    |f(x) - f(x&#39;)|/|f(x&#39;)| = 0.00e+00 ≤ 0.0e+00
    |g(x)|                 = 6.76e-03 ≰ 1.0e-08

 * Work counters
    Seconds run:   2  (vs limit Inf)
    Iterations:    31
    f(x) calls:    159
    ∇f(x) calls:   159
</code></pre><h2 id="References"><a class="docs-heading-anchor" href="#References">References</a><a id="References-1"></a><a class="docs-heading-anchor-permalink" href="#References" title="Permalink"></a></h2><div class="citation noncanonical"><dl><dt>[1]</dt><dd><div>F. Fröhlich and P. K. Sorger. <em>Fides: Reliable trust-region optimization for parameter estimation of ordinary differential equation models</em>. PLoS computational biology <strong>18</strong>, e1010322 (2022).</div></dd></dl></div></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../pest_select/">« Model Selection with PEtab-select</a><a class="docs-footer-nextpage" href="../inference/">Bayesian Inference »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Saturday 23 August 2025 17:51">Saturday 23 August 2025</span>. Using Julia version 1.11.6.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
