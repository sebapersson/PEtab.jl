import{_ as i,c as a,o as e,aA as n}from"./chunks/framework.DLYJsqdg.js";const E=JSON.parse('{"title":"Speeding up gradients for large models (adjoint sensitivities)","description":"","frontmatter":{},"headers":[],"relativePath":"performance/adjoint.md","filePath":"performance/adjoint.md","lastUpdated":null}'),t={name:"performance/adjoint.md"};function l(h,s,p,r,o,d){return e(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="adjoint" tabindex="-1">Speeding up gradients for large models (adjoint sensitivities) <a class="header-anchor" href="#adjoint" aria-label="Permalink to &quot;Speeding up gradients for large models (adjoint sensitivities) {#adjoint}&quot;">​</a></h1><p>For large models, adjoint sensitivity analysis is typically the most efficient way to compute gradients [<a href="/PEtab.jl/previews/PR343/references#frohlich2017scalable">24</a>, <a href="/PEtab.jl/previews/PR343/references#ma2021comparison">25</a>] (mathematical overview is available in [<a href="/PEtab.jl/previews/PR343/references#sapienza2024differentiable">20</a>]. PEtab.jl supports adjoint methods from <a href="https://github.com/SciML/SciMLSensitivity.jl" target="_blank" rel="noreferrer">SciMLSensitivity.jl</a>.</p><p>In practice, performance of adjoint sensitivity is driven by three factors: the adjoint algorithm (quadrature), the Vector–Jacobian product (VJP) backend, and the ODE solver. This page discusses these options and assumes familiarity with PEtab’s derivative methods (see <a href="/PEtab.jl/previews/PR343/configuration/derivatives#gradient_support">Derivative methods (gradients and Hessians)</a>). As a working example, we use the published model Bachmann [<a href="/PEtab.jl/previews/PR343/references#bachmann2011division">28</a>] model which is available in the PEtab standard format (see <a href="/PEtab.jl/previews/PR343/tutorials/define_problem/standard_format#import_petab_problem">Importing PEtab problems</a>). The PEtab files can be downloaded from <a href="https://github.com/sebapersson/PEtab.jl/tree/main/docs/src/assets/bachmann" target="_blank" rel="noreferrer">here</a>, and given the problem YAML file, the model can be imported as:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">using</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PEtab</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># path_yaml depends on where the problem is stored</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">path_yaml </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> joinpath</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@__DIR__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;bachmann&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Bachmann_MSB2011.yaml&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">model </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PEtabModel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(path_yaml)</span></span></code></pre></div><h2 id="Tuning-adjoint-gradients" tabindex="-1">Tuning adjoint gradients <a class="header-anchor" href="#Tuning-adjoint-gradients" aria-label="Permalink to &quot;Tuning adjoint gradients {#Tuning-adjoint-gradients}&quot;">​</a></h2><p>The Bachmann model has 25 ODEs and 113 estimated parameters. Even though <code>gradient_method = :ForwardDiff</code> performs best for this model (see below), it is a useful example for illustrating adjoint tuning. For adjoint gradients, performance is mainly driven by the following <code>PEtabODEProblem</code> options:</p><ol><li><p><code>odesolver_gradient</code>: ODE solver and tolerances (<code>abstol_adj</code>, <code>reltol_adj</code>) used to solve the adjoint problem. In many cases <code>CVODE_BDF()</code> performs well.</p></li><li><p><code>sensealg</code>: Adjoint algorithm and its Vector–Jacobian product (VJP) backend. PEtab.jl supports <code>InterpolatingAdjoint</code>, <code>QuadratureAdjoint</code>, and <code>GaussAdjoint</code> from SciMLSensitivity. A key choice for these is the VJP backend; in practice <code>ReverseDiffVJP(true)</code> is currently the most stable option.</p></li></ol><p>Since <code>QuadratureAdjoint</code> is often less robust, this example compares <code>InterpolatingAdjoint</code> and <code>GaussAdjoint</code>:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">using</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SciMLSensitivity, Sundials</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">solver </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ODESolver</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CVODE_BDF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); abstol_adj </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1e-3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, reltol_adj </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1e-6</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">petab_prob1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PEtabODEProblem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    model;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    gradient_method </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> :Adjoint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    odesolver </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> solver,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    odesolver_gradient </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> solver,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    sensealg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> InterpolatingAdjoint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(autojacvec </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ReverseDiffVJP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">petab_prob2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PEtabODEProblem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    model;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    gradient_method </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> :Adjoint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    odesolver </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> solver,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    odesolver_gradient </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> solver,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    sensealg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> GaussAdjoint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(autojacvec </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ReverseDiffVJP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>Note that SciMLSensitivity must be loaded to use adjoints. The adjoint ODE-solver tolerances are set via <code>abstol_adj</code>/<code>reltol_adj</code> in <code>ODESolver</code> and apply only to the adjoint solve.R Relaxing the adjoint tolerances (relative to the default <code>1e-8</code>) can improve robustness (fewer failed gradient evaluations). Runtime can then be compared as:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">using</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Printf</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> get_x</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(petab_prob1)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">g1, g2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> similar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">similar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">petab_prob1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">grad!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(g1, x)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">petab_prob2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">grad!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(g2, x)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Runtime InterpolatingAdjoint: %.1fs</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, b1)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Runtime GaussAdjoint: %.1fs</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, b2)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Runtime InterpolatingAdjoint: 0.5s</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Runtime GaussAdjoint: 0.7s</span></span></code></pre></div><p>In this setup <code>InterpolatingAdjoint</code> is faster (this can vary across machines).</p><p>Finally, even when <code>gradient_method = :Adjoint</code> is fastest, <code>:ForwardDiff</code> is preferable if it is not substantially slower. Adjoint gradients are more likely to fail (they require an additional difficult backward adjoint solve), and forward-mode methods often produce more accurate gradients [<a href="/PEtab.jl/previews/PR343/references#persson2025petab">1</a>].</p><h2 id="References" tabindex="-1">References <a class="header-anchor" href="#References" aria-label="Permalink to &quot;References {#References}&quot;">​</a></h2><ol><li><p>S. Persson, F. Fröhlich, S. Grein, T. Loman, D. Ognissanti, V. Hasselgren, J. Hasenauer and M. Cvijovic. <em>PEtab. jl: advancing the efficiency and utility of dynamic modelling</em>. Bioinformatics <strong>41</strong>, btaf497 (2025).</p></li><li><p>F. Sapienza, J. Bolibar, F. Schäfer, B. Groenke, A. Pal, V. Boussange, P. Heimbach, G. Hooker, F. Pérez, P.-O. Persson and others. <em>Differentiable Programming for Differential Equations: A Review</em>, arXiv preprint arXiv:2406.09699 (2024).</p></li><li><p>F. Fröhlich, B. Kaltenbacher, F. J. Theis and J. Hasenauer. <em>Scalable parameter estimation for genome-scale biochemical reaction networks</em>. PLoS computational biology <strong>13</strong>, e1005331 (2017).</p></li><li><p>Y. Ma, V. Dixit, M. J. Innes, X. Guo and C. Rackauckas. <em>A comparison of automatic differentiation and continuous sensitivity analysis for derivatives of differential equation solutions</em>. In: <em>2021 IEEE High Performance Extreme Computing Conference (HPEC)</em> (IEEE, 2021); pp. 1–9.</p></li><li><p>J. Bachmann, A. Raue, M. Schilling, M. E. Böhm, C. Kreutz, D. Kaschek, H. Busch, N. Gretz, W. D. Lehmann, J. Timmer and others. <em>Division of labor by dual feedback regulators controls JAK2/STAT5 signaling over broad ligand range</em>. Molecular systems biology <strong>7</strong>, 516 (2011).</p></li></ol>`,16)])])}const c=i(t,[["render",l]]);export{E as __pageData,c as default};
